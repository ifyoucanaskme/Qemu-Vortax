name: Setup SSH + Tailscale + TCP Forwarding

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-ssh-runner:
    runs-on: ubuntu-latest
    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      USERNAME: runner
      PASSWORD: runner
      TAILSCALE_HOSTNAME: gh-ssh-${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Ensure runner user has sudo + password
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install OpenSSH server
        run: |
          echo ">>> Installing OpenSSH..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq openssh-server
          sudo systemctl enable ssh
          sudo systemctl restart ssh

      - name: Install Tailscale
        run: |
          echo ">>> Installing Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          sudo tailscale up --authkey "${TAILSCALE_AUTHKEY}" --hostname "${TAILSCALE_HOSTNAME}"
          sudo tailscale set --operator=$USER

      - name: Forward SSH TCP via tailscale serve
        run: |
          sudo tailscale serve --tcp 2222 tcp://localhost:22 & 
          sleep 2

      - name: Show Connection Info
        run: |
          TAILSCALE_IP=$(tailscale ip -4 | head -n1)
          echo "=== SSH CONNECTION INFO ==="
          echo "IP: ${TAILSCALE_IP}"
          echo "USERNAME: ${USERNAME}"
          echo "PASSWORD: ${PASSWORD}"
          echo
          echo ">>> Connect via SSH on Tailnet:"
          echo "    ssh -p 2222 -o StrictHostKeyChecking=no ${USERNAME}@${TAILSCALE_IP}"
          echo
          echo ">>> TCP Services forwarded via Tailnet:"
          echo "    VNC: ${TAILSCALE_IP}:15900"
          echo "    RDP: ${TAILSCALE_IP}:13389"
          echo "    NoMachine: ${TAILSCALE_IP}:14400"
          echo
          echo ">>> Keeping runner alive..."
          tail -f /dev/null