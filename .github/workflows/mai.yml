name: Mega-Account-Gen-Selenium

on:
  workflow_dispatch:

jobs:
  gen:
    runs-on: windows-latest
    outputs:
      mega_cred: ${{ steps.read.outputs.cred }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python packages
        run: |
          pip install --upgrade pip
          pip install bs4 selenium requests fake_useragent

      - name: Install Chrome and Chromedriver
        shell: powershell
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest https://storage.googleapis.com/chrome-for-testing-public/131.0.6778.85/win64/chrome-win64.zip -OutFile chrome.zip
          Expand-Archive chrome.zip -DestinationPath chrome
          Invoke-WebRequest https://storage.googleapis.com/chrome-for-testing-public/131.0.6778.85/win64/chromedriver-win64.zip -OutFile driver.zip
          Expand-Archive driver.zip -DestinationPath driver
          echo "$PWD/chrome/chrome-win64" | Out-File -FilePath $env:GITHUB_PATH -Append
          echo "$PWD/driver/chromedriver-win64" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Clone Updated Mega-nz-Account-Creators
        run: |
          git clone https://github.com/qemuvortax/Mega-nz-Account-Creators.git
          cd Mega-nz-Account-Creators
          pip install -r requirements.txt || exit 0

      - name: Run Generator (Retry up to 3 times)
        shell: bash
        run: |
          cd Mega-nz-Account-Creators
          tries=0
          success=0
          while [ $tries -lt 3 ]; do
            python accountGenerator.py && success=1 && break
            tries=$((tries+1))
            echo Retry attempt: $tries
          done
          if [ $success -eq 0 ]; then
            echo ERROR: Account generation failed after 3 attempts.
            exit 1
          fi

      - name: Read generated account
        id: read
        shell: bash
        run: |
          file=Mega-nz-Account-Creators/generated_accounts.txt
          line=$(tail -n 1 "$file")
          email=$(echo "$line" | awk '{print $1}')
          pass=$(echo "$line" | awk '{print $2}')
          echo cred="$email $pass" >> $GITHUB_OUTPUT
          echo === GENERATED ACCOUNT ===
          echo "$email $pass"
