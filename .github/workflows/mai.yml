name: Mega-Account-Gen

on:
  workflow_dispatch:

jobs:
  gen:
    runs-on: ubuntu-latest
    outputs:
      mega_cred: ${{ steps.read.outputs.cred }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install megacmd + megatools
        run: |
          sudo apt update
          sudo wget https://mega.nz/linux/repo/xUbuntu_24.10/amd64/megacmd-xUbuntu_24.10_amd64.deb && sudo apt install "$PWD/megacmd-xUbuntu_24.10_amd64.deb"
          sudo wget https://mega.nz/linux/repo/xUbuntu_24.10/amd64/megacmd-xUbuntu_24.10_amd64.deb && sudo apt install "$PWD/megacmd-xUbuntu_24.10_amd64.deb"
          sudo apt install -y megatools
          pip install --upgrade pip

      - name: Clone MEGA-Account-Generator
        run: |
          git clone https://github.com/f-o/MEGA-Account-Generator.git
          cd MEGA-Account-Generator
          pip install -r requirements.txt

      - name: Generate Account (Retry up to 3 Times)
        run: |
          cd MEGA-Account-Generator
          tries=0
          success=0
          while [ $tries -lt 3 ]; do
            python generate_accounts.py -n 1 && success=1 && break
            tries=$((tries+1))
            echo "Retry attempt: $tries"
          done
          if [ $success -eq 0 ]; then
            echo "ERROR: Account generation failed after 3 attempts."
            exit 1
          fi

      - name: Read CSV
        id: read
        run: |
          line=$(tail -n 1 MEGA-Account-Generator/accounts.csv)
          email=$(echo "$line" | cut -d',' -f1)
          pass=$(echo "$line" | cut -d',' -f2)
          echo "cred=$email $pass" >> $GITHUB_OUTPUT
          echo "=== GENERATED ACCOUNT ==="
          echo "$email $pass"
