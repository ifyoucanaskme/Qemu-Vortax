name: Mega-Account-Gen-Selenium

on:
  workflow_dispatch:

jobs:
  gen:
    runs-on: ubuntu-latest
    outputs:
      mega_cred: ${{ steps.read.outputs.cred }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y wget unzip xvfb chromium-browser chromium-chromedriver
          pip install --upgrade pip

      - name: Clone Mega-nz-Account-Creators
        run: |
          git clone https://github.com/techux/Mega-nz-Account-Creators.git
          cd Mega-nz-Account-Creators
          pip install -r requirements.txt

      - name: Run Generator (Retry up to 3 times)
        run: |
          cd Mega-nz-Account-Creators
          tries=0
          success=0
          while [ $tries -lt 3 ]; do
            xvfb-run python accountGenerator.py && success=1 && break
            tries=$((tries+1))
            echo "Retry attempt: $tries"
          done
          if [ $success -eq 0 ]; then
            echo "ERROR: Account generation failed after 3 attempts."
            exit 1
          fi

      - name: Read generated account
        id: read
        run: |
          file=Mega-nz-Account-Creators/generated_accounts.txt
          line=$(tail -n 1 "$file")
          email=$(echo "$line" | awk '{print $1}')
          pass=$(echo "$line" | awk '{print $2}')
          echo "cred=$email $pass" >> $GITHUB_OUTPUT
          echo "=== GENERATED ACCOUNT ==="
          echo "$email $pass"
