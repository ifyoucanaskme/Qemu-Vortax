name: Mega Account Generator

on:
  workflow_dispatch:

jobs:
  generate-mega-account:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install megacmd
        run: |
          sudo wget https://mega.nz/linux/repo/xUbuntu_24.10/amd64/megacmd-xUbuntu_24.10_amd64.deb
          sudo apt install -y "$PWD/megacmd-xUbuntu_24.10_amd64.deb"

      - name: Clone py_mega_account_generator
        run: |
          git clone https://github.com/qtchaos/py_mega_account_generator.git
          cd py_mega_account_generator
          pip install -r requirements.txt

      - name: Generate Mega account
        id: generate_account
        run: |
          cd py_mega_account_generator
          ATTEMPTS=0
          SUCCESS=0
          while [ $ATTEMPTS -lt 5 ] && [ $SUCCESS -eq 0 ]; do
            OUTPUT=$(python main.py 2>&1)
            if echo "$OUTPUT" | grep -q '"email":'; then
              ACCOUNT=$(echo "$OUTPUT" | grep '"email":' -A2 | tr -d ' "{}' | tr '\n' ' ' | awk '{print $2 "#" $6}')
              SUCCESS=1
            else
              ATTEMPTS=$((ATTEMPTS+1))
              echo "Retry attempt: $ATTEMPTS"
            fi
          done
          if [ $SUCCESS -eq 0 ]; then
            echo "Failed to generate account after 5 attempts."
            exit 1
          fi
          echo "mega_account=$ACCOUNT" >> $GITHUB_ENV

      - name: Show generated account
        run: |
          echo "Generated Mega account: ${{ env.mega_account }}"
