name: Mega.nz Account Generator + XFCE VNC

on:
  workflow_dispatch:

jobs:
  generate-account:
    runs-on: ubuntu-latest
    env:
      USERNAME: runner
      PASSWORD: runner

    steps:
      - uses: actions/checkout@v4

      - name: Ensure runner user has sudo
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install XFCE + VNC server
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq xfce4 xfce4-terminal dbus-x11 xorg tigervnc-standalone-server tigervnc-common tigervnc-tools
          mkdir -p /home/${USERNAME}/.vnc
          echo ${PASSWORD} | vncpasswd -f > /home/${USERNAME}/.vnc/passwd
          chmod 600 /home/${USERNAME}/.vnc/passwd
          chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc
          echo "startxfce4" > /home/${USERNAME}/.xsession
          chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.xsession
          sudo -u ${USERNAME} vncserver :1 -geometry 1280x800 -depth 24 -localhost no

      - name: Install dependencies
        run: |
          sudo apt-get install -y python3 python3-pip git wget
          pip install --upgrade pip

      - name: Install MegaCMD
        run: |
          sudo wget https://mega.nz/linux/repo/xUbuntu_24.10/amd64/megacmd-xUbuntu_24.10_amd64.deb
          sudo apt install -y "$PWD/megacmd-xUbuntu_24.10_amd64.deb"

      - name: Clone latest Mega-nz-Account-Creators
        run: |
          git clone https://github.com/qemuvortax/Mega-nz-Account-Creators.git
          cd Mega-nz-Account-Creators
          pip install -r requirements.txt

      - name: Generate single account
        id: generate
        run: |
          cd Mega-nz-Account-Creators
          ATTEMPTS=0
          MAX=5
          ACCOUNT=""
          PASSWORD=""
          while [ $ATTEMPTS -lt $MAX ]; do
            OUTPUT=$(python3 accountGenerator.py 2>&1)
            ACCOUNT=$(echo "$OUTPUT" | grep -oP "[\w\.-]+@[\w\.-]+\.\w+")
            PASSWORD=$(echo "$OUTPUT" | grep -oP "Password:\s*\K\S+")
            if [ -n "$ACCOUNT" ] && [ -n "$PASSWORD" ]; then
              break
            fi
            ATTEMPTS=$((ATTEMPTS+1))
          done
          echo "::set-output name=account::$ACCOUNT"
          echo "::set-output name=password::$PASSWORD"

      - name: Show generated account
        run: |
          echo "ACCOUNT: ${{ steps.generate.outputs.account }}"
          echo "PASSWORD: ${{ steps.generate.outputs.password }}"

      - name: Keep runner alive
        run: tail -f /dev/null
